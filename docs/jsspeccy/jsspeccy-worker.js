(()=>{"use strict";const e="Spectrum128K_1";class t{constructor(e,t){this.pulseLength=e,this.pulseCount=t,this.pulsesGenerated=0}isFinished(){return this.pulsesGenerated==this.pulseCount}getNextPulseLength(){return this.pulsesGenerated++,this.pulseLength}}class s{constructor(e){this.pulses=e,this.index=0}isFinished(){return this.index==this.pulses.length}getNextPulseLength(){return this.pulses[this.index++]}}class n{constructor(e,t,s,n){this.data=e,this.zeroPulseLength=t,this.onePulseLength=s,this.bitCount=8*(this.data.length-1)+n,this.pulsesOutput=0,this.lastPulseLength=null}isFinished(){return this.pulsesOutput==2*this.bitCount}getNextPulseLength(){if(1&this.pulsesOutput)return this.pulsesOutput++,this.lastPulseLength;{const e=this.pulsesOutput>>1,t=e>>3,s=1<<7-(7&e);return this.lastPulseLength=this.data[t]&s?this.onePulseLength:this.zeroPulseLength,this.pulsesOutput++,this.lastPulseLength}}}class a{constructor(e){this.duration=e,this.emitted=!1}isFinished(){return this.emitted}getNextPulseLength(){return this.emitted=!0,3500*this.duration}}class i{constructor(e){this.segments=[],this.getSegments=e,this.level=0,this.tapeIsFinished=!1,this.pendingCycles=0}addSegment(e){this.segments.push(e)}emitPulses(e,t,s){let n=0,a=t,i=!1;for(;n<s;)if(this.pendingCycles>0)this.pendingCycles>=32768?(e[a++]=32767|this.level,n+=32767,this.pendingCycles-=32767):(e[a++]=this.level|this.pendingCycles,n+=this.pendingCycles,this.pendingCycles=0);else if(0===this.segments.length){if(this.tapeIsFinished){i=!0;break}this.tapeIsFinished=!this.getSegments(this)}else this.segments[0].isFinished()?this.segments.shift():(this.pendingCycles=this.segments[0].getNextPulseLength(),this.level^=32768);return[a,n,i]}}class r{constructor(e){let r=0;this.blocks=[];for(var o=new DataView(e);r+1<e.byteLength;){const t=o.getUint16(r,!0);r+=2,this.blocks.push(new Uint8Array(e,r,t)),r+=t}this.nextBlockIndex=0,this.pulseGenerator=new i(e=>{if(0===this.blocks.length)return!1;const i=this.blocks[this.nextBlockIndex];return this.nextBlockIndex=(this.nextBlockIndex+1)%this.blocks.length,128&i[0]?e.addSegment(new t(2168,3223)):e.addSegment(new t(2168,8063)),e.addSegment(new s([667,735])),e.addSegment(new n(i,855,1710,8)),e.addSegment(new a(1e3)),0!=this.nextBlockIndex})}getNextLoadableBlock(){if(0===this.blocks.length)return null;const e=this.blocks[this.nextBlockIndex];return this.nextBlockIndex=(this.nextBlockIndex+1)%this.blocks.length,e}static isValid(e){let t=0;const s=new DataView(e);for(;t<e.byteLength;){if(t+1>=e.byteLength)return!1;t+=s.getUint16(t,!0)+2}return t==e.byteLength}}class o{static isValid(e){const t=new DataView(e);for(let e=0;e<8;e++)if("ZXTape!".charCodeAt(e)!=t.getUint8(e))return!1;return!0}constructor(e){this.blocks=[];const r=new DataView(e);let o=10;for(;o<e.byteLength;){const i=r.getUint8(o);switch(o++,i){case 16:(()=>{const i=r.getUint16(o,!0);o+=2;const l=r.getUint16(o,!0);o+=2;const c=new Uint8Array(e,o,l);this.blocks.push({type:"StandardSpeedData",pause:i,data:c,generatePulses:e=>{128&c[0]?e.addSegment(new t(2168,3223)):e.addSegment(new t(2168,8063)),e.addSegment(new s([667,735])),e.addSegment(new n(c,855,1710,8)),i&&e.addSegment(new a(i))}}),o+=l})();break;case 17:(()=>{const i=r.getUint16(o,!0);o+=2;const l=r.getUint16(o,!0);o+=2;const c=r.getUint16(o,!0);o+=2;const u=r.getUint16(o,!0);o+=2;const h=r.getUint16(o,!0);o+=2;const d=r.getUint16(o,!0);o+=2;const p=r.getUint8(o);o+=1;const g=r.getUint16(o,!0);o+=2;const k=r.getUint16(o,!0)|r.getUint8(o+2)<<16;o+=3;const f=new Uint8Array(e,o,k);this.blocks.push({type:"TurboSpeedData",pilotPulseLength:i,syncPulse1Length:l,syncPulse2Length:c,zeroBitLength:u,oneBitLength:h,pilotPulseCount:d,lastByteMask:p,pause:g,data:f,generatePulses:e=>{e.addSegment(new t(i,d)),e.addSegment(new s([l,c])),e.addSegment(new n(f,u,h,p)),g&&e.addSegment(new a(g))}}),o+=k})();break;case 18:(()=>{const e=r.getUint16(o,!0);o+=2;const s=r.getUint16(o,!0);o+=2,this.blocks.push({type:"PureTone",pulseLength:e,pulseCount:s,generatePulses:n=>{n.addSegment(new t(e,s))}})})();break;case 19:(()=>{const e=r.getUint8(o);o+=1;const t=[];for(let s=0;s<e;s++)t[s]=r.getUint16(o+2*s,!0);this.blocks.push({type:"PulseSequence",pulseLengths:t,generatePulses:e=>{e.addSegment(new s(t))}}),o+=2*e})();break;case 20:(()=>{const t=r.getUint16(o,!0);o+=2;const s=r.getUint16(o,!0);o+=2;const i=r.getUint8(o);o+=1;const l=r.getUint16(o,!0);o+=2;const c=r.getUint16(o,!0)|r.getUint8(o+2)<<16;o+=3;const u=new Uint8Array(e,o,c);this.blocks.push({type:"PureData",zeroBitLength:t,oneBitLength:s,lastByteMask:i,pause:l,data:u,generatePulses:e=>{e.addSegment(new n(u,t,s,i)),l&&e.addSegment(new a(l))}}),o+=c})();break;case 21:(()=>{const t=r.getUint16(o,!0);o+=2;const s=r.getUint16(o,!0);o+=2;const n=r.getUint8(o);o+=1;const a=r.getUint16(o,!0)|r.getUint8(o+2)<<16;o+=3,this.blocks.push({type:"DirectRecording",tstatesPerSample:t,lastByteMask:n,pause:s,data:new Uint8Array(e,o,a)}),o+=a})();break;case 32:(()=>{const e=r.getUint16(o,!0);o+=2,this.blocks.push({type:"Pause",pause:e,generatePulses:t=>{t.addSegment(new a(e))}})})();break;case 33:(()=>{const t=r.getUint8(o);o+=1;const s=new Uint8Array(e,o,t);o+=t;const n=String.fromCharCode.apply(null,s);this.blocks.push({type:"GroupStart",name:n})})();break;case 34:(()=>{this.blocks.push({type:"GroupEnd"})})();break;case 35:(()=>{const e=r.getUint16(o,!0);o+=2,this.blocks.push({type:"JumpToBlock",offset:e})})();break;case 36:(()=>{const e=r.getUint16(o,!0);o+=2,this.blocks.push({type:"LoopStart",repeatCount:e})})();break;case 37:(()=>{this.blocks.push({type:"LoopEnd"})})();break;case 38:(()=>{const e=r.getUint16(o,!0);o+=2;const t=[];for(let s=0;s<e;s++)t[s]=r.getUint16(o+2*s,!0);this.blocks.push({type:"CallSequence",offsets:t}),o+=2*e})();break;case 39:(()=>{this.blocks.push({type:"ReturnFromSequence"})})();break;case 40:(()=>{const t=r.getUint16(o,!0);o+=2,this.blocks.push({type:"Select",data:new Uint8Array(e,o,t)}),o+=t})();break;case 48:(()=>{const t=r.getUint8(o);o+=1;const s=new Uint8Array(e,o,t);o+=t;const n=String.fromCharCode.apply(null,s);this.blocks.push({type:"TextDescription",text:n})})();break;case 49:(()=>{const t=r.getUint8(o);o+=1;const s=r.getUint8(o);o+=1;const n=new Uint8Array(e,o,s);o+=s;const a=String.fromCharCode.apply(null,n);this.blocks.push({type:"MessageBlock",displayTime:t,text:a})})();break;case 50:(()=>{const t=r.getUint16(o,!0);o+=2,this.blocks.push({type:"ArchiveInfo",data:new Uint8Array(e,o,t)}),o+=t})();break;case 51:(()=>{const t=3*r.getUint8(o);o+=1,this.blocks.push({type:"HardwareType",data:new Uint8Array(e,o,t)}),o+=t})();break;case 53:(()=>{const t=new Uint8Array(e,o,10);o+=10;const s=String.fromCharCode.apply(null,t),n=r.getUint32(o,!0);this.blocks.push({type:"CustomInfo",identifier:s,data:new Uint8Array(e,o,n)}),o+=n})();break;case 90:(()=>{o+=9,this.blocks.push({type:"Glue"})})();break;default:(()=>{const t=r.getUint32(o,!0);o+=4,this.blocks.push({type:"unknown",data:new Uint8Array(e,o,t)}),o+=t})()}}this.nextBlockIndex=0,this.loopToBlockIndex,this.repeatCount,this.callStack=[],this.pulseGenerator=new i(e=>{const t=this.getNextMeaningfulBlock(!1);return!!t&&(t.generatePulses(e),!0)})}getNextMeaningfulBlock(e){let t=0===this.nextBlockIndex;for(;;){if(this.nextBlockIndex>=this.blocks.length){if(t||!e)return null;this.nextBlockIndex=0,t=!0}var s=this.blocks[this.nextBlockIndex];switch(s.type){case"StandardSpeedData":case"TurboSpeedData":case"PureTone":case"PulseSequence":case"PureData":case"DirectRecording":case"Pause":return this.nextBlockIndex++,s;case"JumpToBlock":this.nextBlockIndex+=s.offset;break;case"LoopStart":this.loopToBlockIndex=this.nextBlockIndex+1,this.repeatCount=s.repeatCount,this.nextBlockIndex++;break;case"LoopEnd":this.repeatCount--,this.repeatCount>0?this.nextBlockIndex=this.loopToBlockIndex:this.nextBlockIndex++;break;case"CallSequence":this.callStack.unshift(this.nextBlockIndex+1);for(var n=s.offsets.length-1;n>=0;n--)this.callStack.unshift(this.nextBlockIndex+s.offsets[n]);this.nextBlockIndex=this.callStack.shift();break;case"ReturnFromSequence":this.nextBlockIndex=this.callStack.shift();break;default:this.nextBlockIndex++}}}getNextLoadableBlock(){for(;;){var e=this.getNextMeaningfulBlock(!0);if(!e)return null;if("StandardSpeedData"==e.type||"TurboSpeedData"==e.type)return e.data}}}let l=null,c=null,u=null,h=null,d=null,p=null,g=null,k=!1,f=null,b=!1,m=-1,y=!0,U={},w=new ArrayBuffer(16384);const x=(e,t)=>{u.set(t,l.MACHINE_MEMORY+16384*e)},S=e=>{y=e,l.setTapeTraps(0==m&&y,1==m&&y)},P=t=>{switch(l.setMachineType(t),t){case 16:case 48:case 1221:B("Spectrum48K"),m=0;break;case 5:B("Pentagon_0",e,"BetaDisk"),m=1;break;case 128:B("Spectrum128K_0",e),m=1;break;default:m=-1,console.error("Unrecognised machine type:",t)}S(y)},B=(e,t,s)=>{x(l.ROM_PAGE_0,U[e]||w),x(l.ROM_PAGE_1,U[t]||w),x(l.ROM_PAGE_DOS,U[s]||w)},L=()=>{if(!f)return;const e=f.getNextLoadableBlock();if(!e)return;const t=d[4],s=t>>8,n=1&t;let a=d[8];const i=d[2],r=e[0];let o=!0;if(s!=r)o=!1;else if(n){let t=1,s=0,n=r;for(;s<i;){if(t>=e.length){o=!1;break}const i=e[t++];s++,l.poke(a,i),a=a+1&65535,n^=i}o&=t<e.length,o&&(o=n===e[t])}else o=!0;o?d[0]|=1:d[0]&=65534,l.setPC(1506)};onmessage=e=>{switch(e.data.message){case"loadCore":t=e.data.baseUrl,WebAssembly.instantiateStreaming(fetch(new URL("jsspeccy-core.wasm",t),{})).then(e=>{l=e.instance.exports,c=l.memory,u=new Uint8Array(c.buffer),h=u.subarray(l.FRAME_BUFFER,32256),d=new Uint16Array(l.memory.buffer,l.REGISTERS,12),p=new Uint16Array(l.memory.buffer,l.TAPE_PULSES,l.TAPE_PULSES_LENGTH),g=new Uint8Array(l.memory.buffer,l.ULA_PLUS_PALETTE,64),postMessage({message:"ready"})});break;case"runFrame":if(k)return;const s=e.data.frameBuffer,n=new Uint8Array(s);let a=null,i=null,m=0;if("audioBufferLeft"in e.data?(a=e.data.audioBufferLeft,i=e.data.audioBufferRight,m=a.byteLength/4,l.setAudioSamplesPerFrame(m)):l.setAudioSamplesPerFrame(0),f&&b){const e=l.getTapePulseBufferTstateCount(),t=l.getTapePulseWriteIndex(),[s,n,a]=f.pulseGenerator.emitPulses(p,t,8e4-e);l.setTapePulseBufferState(s,e+n),a&&(b=!1,postMessage({message:"stoppedTape"}))}let y=l.runFrame();for(;y;){switch(y){case 1:throw k=!0,"Unrecognised opcode!";case 2:L();break;default:throw k=!0,"runFrame returned unexpected result: "+y}y=l.resumeFrame()}if(n.set(h),m){const e=new Float32Array(l.memory.buffer,l.AUDIO_BUFFER_LEFT,m),t=new Float32Array(l.memory.buffer,l.AUDIO_BUFFER_RIGHT,m),n=new Float32Array(a),r=new Float32Array(i);n.set(e),r.set(t),postMessage({message:"frameCompleted",frameBuffer:s,audioBufferLeft:a,audioBufferRight:i},[s,a,i])}else postMessage({message:"frameCompleted",frameBuffer:s},[s]);break;case"keyDown":l.keyDown(e.data.row,e.data.mask);break;case"keyUp":l.keyUp(e.data.row,e.data.mask);break;case"setMachineType":P(e.data.type);break;case"setUlaPlusEnabled":l.setUlaPlusEnabled(e.data.value);break;case"reset":l.reset();break;case"loadRom":U[e.data.name]=e.data.data;break;case"loadMemory":x(e.data.page,e.data.data);break;case"loadSnapshot":(e=>{P(e.model);for(let t in e.memoryPages)x(t,e.memoryPages[t]);["AF","BC","DE","HL","AF_","BC_","DE_","HL_","IX","IY","SP","IR"].forEach((t,s)=>{d[s]=e.registers[t]}),l.setPC(e.registers.PC),l.setIFF1(e.registers.iff1),l.setIFF2(e.registers.iff2),l.setIM(e.registers.im),l.setHalted(!!e.halted),l.writePort(254,e.ulaState.borderColour),48!=e.model&&l.writePort(32765,e.ulaState.pagingFlags);const t=e.palette;t&&(g.set(t.entries,0),l.setUlaPlusPaletteMode(t.isEnabled),l.setUlaPlusGroupAndSubgroup(t.currentGroup,t.currentIndex)),l.setTStates(e.tstates)})(e.data.snapshot),postMessage({message:"fileOpened",id:e.data.id,mediaType:"snapshot"});break;case"openTAPFile":f=new r(e.data.data),b=!1,postMessage({message:"fileOpened",id:e.data.id,mediaType:"tape"});break;case"openTZXFile":f=new o(e.data.data),b=!1,postMessage({message:"fileOpened",id:e.data.id,mediaType:"tape"});break;case"playTape":f&&!b&&(b=!0,postMessage({message:"playingTape"}));break;case"stopTape":f&&b&&(b=!1,postMessage({message:"stoppedTape"}));break;case"setTapeTraps":S(e.data.value);break;default:console.log("message received by worker:",e.data)}var t}})();